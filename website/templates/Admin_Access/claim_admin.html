{% extends "Admin_Access/admin_base.html" %}
{% block title %}Expense Claims{% endblock %}

{% block content %}
<h2 class="text-center my-3">Expense Claims ({{ view|capitalize }})</h2>

<div class="admin_container">

  <!-- Filters -->
  <div class="admin_Access-filter-box mb-3">
    <form id="claimFilterForm" class="admin-box-form" method="GET">
      <!-- Employee Type -->
      <label for="emp_type_claim">Employee Type:</label>
      <select name="emp_type_claim" id="emp_type_claim">
        <option value="">-- Select Employee Type --</option>
        <option value="Engineering" {% if emp_type=="Engineering" %}selected{% endif %}>Engineering</option>
        <option value="Human Resource" {% if emp_type=="Human Resource" %}selected{% endif %}>Human Resource</option>
        <option value="Admin" {% if emp_type=="Admin" %}selected{% endif %}>Admin</option>
        <option value="Accounts" {% if emp_type=="Accounts" %}selected{% endif %}>Accounts</option>
        <option value="TEC" {% if emp_type=="TEC" %}selected{% endif %}>TEC</option>
        <option value="Certification" {% if emp_type=="Certification" %}selected{% endif %}>Certification</option>
        <option value="Software_Development" {% if emp_type=="Software_Development" %}selected{% endif %}>Software Development</option>
        <option value="It Department" {% if emp_type=="It Department" %}selected{% endif %}>IT Department</option>
      </select>

      <!-- Circle -->
      <label for="circle_claim">Circle:</label>
      <select name="circle_claim" id="circle_claim">
        <option value="">-- Select Circle --</option>
        <option value="">-- Select Circle --</option>
        <option value="NHQ" {% if circle=="NHQ" %}selected{% endif %}>NHQ</option>
        <option value="Noida" {% if circle=="Noida" %}selected{% endif %}>Noida</option>
        <option value="Noida-Loire" {% if circle=="Noida-Loire" %}selected{% endif %}>Noida-Loire</option>
        <option value="Haryana" {% if circle=="Haryana" %}selected{% endif %}>Haryana</option>
        <option value="Haryana-Loyal" {% if circle=="Haryana-Loyal" %}selected{% endif %}>Haryana-Loyal</option>
        <option value="Gurugram" {% if circle=="Gurugram" %}selected{% endif %}>Gurugram</option>
        <option value="Gurugram-Awesome" {% if circle=="Gurugram-Awesome" %}selected{% endif %}>Gurugram-Awesome</option>
        <option value="Gurugram-Rabbit" {% if circle=="Gurugram-Rabbit" %}selected{% endif %}>Gurugram-Rabbit</option>
        <option value="Pune" {% if circle=="Pune" %}selected{% endif %}>Pune</option>
        <option value="Jaipur" {% if circle=="Jaipur" %}selected{% endif %}>Jaipur</option>
        <option value="Jaipur-Rabbit" {% if circle=="Jaipur-Rabbit" %}selected{% endif %}>Jaipur-Rabbit</option>
        <option value="Greater Noida" {% if circle=="Greater Noida" %}selected{% endif %}>Greater Noida</option>
        <option value="Mumbai" {% if circle=="Mumbai" %}selected{% endif %}>Mumbai</option>
        <option value="G.Noida-Rabbit" {% if circle=="G.Noida-Rabbit" %}selected{% endif %}>G.Noida-Rabbit</option>
        <option value="Mumbai-Bonita" {% if circle=="Mumbai-Bonita" %}selected{% endif %}>Mumbai-Bonita</option>
        <option value="Mumbai-Victory" {% if circle=="Mumbai-Victory" %}selected{% endif %}>Mumbai-Victory</option>
        <option value="Mumbai-Rabbit" {% if circle=="Mumbai-Rabbit" %}selected{% endif %}>Mumbai-Rabbit</option>
        <option value="Ahmedabad" {% if circle=="Ahmedabad" %}selected{% endif %}>Ahmedabad</option>
        <option value="Bangalore" {% if circle=="Bangalore" %}selected{% endif %}>Bangalore</option>
        <option value="Punjab" {% if circle=="Punjab" %}selected{% endif %}>Punjab</option>
        <option value="Punjab-Loyal" {% if circle=="Punjab-Loyal" %}selected{% endif %}>Punjab-Loyal</option>
        <option value="Hyderabad" {% if circle=="Hyderabad" %}selected{% endif %}>Hyderabad</option>
        <option value="Chennai" {% if circle=="Chennai" %}selected{% endif %}>Chennai</option>
        <option value="Kolkata" {% if circle=="Kolkata" %}selected{% endif %}>Kolkata</option>
        <option value="Kolkata-Rabbit" {% if circle=="Kolkata-Rabbit" %}selected{% endif %}>Kolkata-Rabbit</option>
      </select>

      <!-- Claim View -->
      <label for="view">Claims:</label>
      <select name="view" id="view">
        <option value="pending" {% if view=="pending" %}selected{% endif %}>Pending Claims</option>
        <option value="all" {% if view=="all" %}selected{% endif %}>All Claims</option>
      </select>
    </form>
  </div>

  <!-- Claim Table -->
  <div class="admin_table_box">
    <table class="admin_table">
      <thead>
        <tr>
          <th>Employee</th>
          <th>Designation</th>
          <th>Project</th>
          <th>Travel Dates</th>
          <th>Total Amount</th>
          <th>Status</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {% for claim in claims %}
        <tr>
          <td>{{ claim.employee_name }}</td>
          <td>{{ claim.designation }}</td>
          <td>{{ claim.project_name }}</td>
          <td>{{ claim.travel_from_date }} â†’ {{ claim.travel_to_date }}</td>
          <td>{{ claim.expenses | sum(attribute='amount') }}</td>
          <td>{{ claim.overall_status }}</td>
          <td>
            <button type="button" onclick="toggleDetails({{ claim.id }})">View</button>
          </td>
        </tr>
        <tr id="details-{{ claim.id }}" style="display:none;">
          <td colspan="7">
            <table class="admin_table">
              <thead>
                <tr>
                  <th>Sr No</th>
                  <th>Date</th>
                  <th>Purpose</th>
                  <th>Amount</th>
                  <th>Currency</th>
                  <th>Attachment</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
              {% for item in claim.expenses %}
                <tr>
                  <td>{{ item.sr_no }}</td>
                  <td>{{ item.date }}</td>
                  <td>{{ item.purpose }}</td>
                  <td>{{ item.amount }}</td>
                  <td>{{ item.currency }}</td>
                  <td>
                    {% if item.Attach_file %}
                      <a href="{{ url_for('static', filename='uploads/' ~ item.Attach_file) }}" target="_blank">View</a>
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>{{ item.status }}</td>
                  <td>
                    {% if item.status == 'Pending' %}
                      <form method="post" action="{{ url_for('Admins_access.update_claim_status', item_id=item.id, action='approve') }}" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit">Approve</button>
                      </form>
                      <form method="post" action="{{ url_for('Admins_access.update_claim_status', item_id=item.id, action='reject') }}" style="display:inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button  type="submit">Reject</button>
                      </form>
                    {% else %}
                      <span class="status-label">{{ item.status }}</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="7">No claims found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Auto-submit filter on change -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("claimFilterForm");
  form.querySelectorAll("select").forEach(select => {
    select.addEventListener("change", function () {
      form.submit();
    });
  });
});

function toggleDetails(id) {
  var row = document.getElementById("details-" + id);
  row.style.display = (row.style.display === "none") ? "" : "none";
}
</script>
{% endblock %}
